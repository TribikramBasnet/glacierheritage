<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Source Code</title>
    <!-- Use the same external stylesheets as the home page -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <!-- Link to the main style file in the parent directory -->
    <link rel="stylesheet" href="../css/style.css" />
    <style>
        /* Additional styling for the code blocks */
        .code-section {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        .code-container {
            position: relative;
            margin-top: 15px;
        }
        .code-container pre {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>

    <!-- This div will now load the new shared header from header.html -->
    <div data-include-html="../includes/header.html"></div>

    <!-- Main Content for the Source Code Page -->
    <div class="container mt-4 mb-4">
        <!-- The page header, centered below the main site header -->
        <h1 class="my-0 text-center">Source Code</h1>

        <h2 class="mt-4">Methodology</h2>
        <p>
            The satellite imagery for our analysis was generated using Google Earth Engine (GEE). For the present conditions (2024), we fetched post-monsoon Landsat 8 imagery, selecting images with less than 20% cloud cover. When multiple images were available that met this criteria, we took the median to ensure the cleanest possible representation.
            Similarly, for the historical data (1992), we used Landsat 5 imagery and applied the same cloud filtering and median-of-available-images approach. The lake area was calculated by creating water masks and performing Normalized Difference Water Index (NDWI) calculations directly within the GEE platform. The following are the GEE scripts used for this process.
        </p>

        <!-- Code Block 1: Landsat 8 Imagery (2024) -->
        <div class="code-section">
            <h5 class="mb-3">1. Landsat 8 Imagery (2024)</h5>
            <div class="code-container">
                <button class="btn btn-outline-primary btn-sm copy-btn" onclick="copyCode('code-block-1')">Copy Code</button>
                <pre><code id="code-block-1">
// Define the region of interest for your glacier.
var roi = ee.Geometry.Polygon([[86.915, 27.89], [86.915, 27.90], [86.92, 27.90], [86.92, 27.89]]);

// Function to mask clouds in Landsat 8 imagery.
function maskL8sr(image) {
    var cloudShadowBitMask = (1 << 3);
    var cirrusBitMask = (1 << 1);
    var cloudsBitMask = (1 << 5);
    var qa = image.select('QA_PIXEL');
    var mask = qa.bitwiseAnd(cloudShadowBitMask).eq(0)
                 .and(qa.bitwiseAnd(cirrusBitMask).eq(0))
                 .and(qa.bitwiseAnd(cloudsBitMask).eq(0));
    return image.updateMask(mask);
}

// Filter Landsat 8 collection for post-monsoon 2024 with low cloud cover.
var l8 = ee.ImageCollection('LANDSAT/LC08/C02/T1_L2')
             .filterDate('2024-09-01', '2024-11-30')
             .filterBounds(roi)
             .map(maskL8sr)
             .median(); // Use median to handle multiple images

// Display the result on the map.
var visParams = {bands: ['SR_B4', 'SR_B3', 'SR_B2'], min: 0, max: 0.3};
Map.addLayer(l8, visParams, 'Landsat 8 - 2024');
Map.centerObject(roi, 12);
                </code></pre>
            </div>
        </div>

        <!-- Code Block 2: Landsat 5 Imagery (1992) -->
        <div class="code-section">
            <h5 class="mb-3">2. Landsat 5 Imagery (1992)</h5>
            <div class="code-container">
                <button class="btn btn-outline-primary btn-sm copy-btn" onclick="copyCode('code-block-2')">Copy Code</button>
                <pre><code id="code-block-2">
// Define the region of interest for your glacier.
var roi = ee.Geometry.Polygon([[86.915, 27.89], [86.915, 27.90], [86.92, 27.90], [86.92, 27.89]]);

// Function to mask clouds in Landsat 5 imagery.
function maskL5sr(image) {
    var qa = image.select('pixel_qa');
    var mask = qa.bitwiseAnd(4).eq(0).and(qa.bitwiseAnd(8).eq(0));
    return image.updateMask(mask);
}

// Filter Landsat 5 collection for post-monsoon 1992 with low cloud cover.
var l5 = ee.ImageCollection('LANDSAT/LT05/C01/T1_SR')
             .filterDate('1992-09-01', '1992-11-30')
             .filterBounds(roi)
             .map(maskL5sr)
             .median(); // Use median to handle multiple images

// Display the result on the map.
var visParams = {bands: ['B3', 'B2', 'B1'], min: 0, max: 0.3};
Map.addLayer(l5, visParams, 'Landsat 5 - 1992');
Map.centerObject(roi, 12);
                </code></pre>
            </div>
        </div>

        <!-- Code Block 3: Area Calculation -->
        <div class="code-section">
            <h5 class="mb-3">3. Lake Area Calculation</h5>
            <div class="code-container">
                <button class="btn btn-outline-primary btn-sm copy-btn" onclick="copyCode('code-block-3')">Copy Code</button>
                <pre><code id="code-block-3">
// This script assumes you have already defined a 'lake' geometry and a 'lake_image' (e.g., from the previous code blocks).
// In GEE, you would typically draw a polygon around the lake to define the ROI.

// Define the lake geometry (example placeholder)
var lake = ee.Geometry.Polygon([[86.915, 27.89], [86.915, 27.90], [86.92, 27.90], [86.92, 27.89]]);

// Function to calculate NDWI and create a water mask
function calculateNDWI(image) {
    var ndwi = image.normalizedDifference(['SR_B3', 'SR_B5']).rename('NDWI');
    var water_mask = ndwi.gt(0.2); // A simple threshold to create a water mask
    return water_mask.set('system:time_start', image.get('system:time_start'));
}

// Apply the function to the image (assuming 'l8' is your Landsat 8 image from the previous script)
var water_mask = calculateNDWI(l8);

// Calculate the area of the water mask in square kilometers.
var area_sq_km = water_mask.multiply(ee.Image.pixelArea()).reduceRegion({
    reducer: ee.Reducer.sum(),
    geometry: lake,
    scale: 30, // Landsat resolution
    maxPixels: 1e9
}).get('NDWI');

// Print the result to the GEE console.
print('Lake Area in 2024 (sq km):', ee.Number(area_sq_km).divide(1e6));
                </code></pre>
            </div>
        </div>
    </div>

    <!-- The Footer Section, which is now included from the master chunk -->
    <div data-include-html="../includes/footer.html"></div>
    
    <!-- This script loads the content from the footer.html and header.html files -->
    <script src="../js/include.js"></script>
    <script>
        // Function to copy the code from a given element ID to the clipboard
        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            const range = document.createRange();
            range.selectNode(codeElement);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                // Use document.execCommand('copy') which is widely supported in iframes
                document.execCommand('copy');
                alert('Code copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy code: ', err);
                alert('Failed to copy code. Please select and copy manually.');
            }
            window.getSelection().removeAllRanges();
        }
    </script>
</body>
</html>
